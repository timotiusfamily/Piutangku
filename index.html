<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PiutangKu - Aplikasi Piutang</title>

  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#2563eb" />

  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --bg: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e6eef9;
      --primary: #2563eb;
      --success: #16a34a;
      --warn: #f59e0b;
      --danger: #dc2626;
      --radius: 14px;
      --shadow: 0 6px 24px rgba(2,6,23,.06);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font: 500 15px/1.6 system-ui, Roboto, 'Segoe UI', Arial; }

    .app { max-width: 980px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; }
    .hidden { display: none !important; }

    /* Login Screen */
    .login-screen {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      min-height: 100vh; padding: 20px; background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
    }
    .login-card {
      width: 100%; max-width: 400px; background: #fff; border-radius: var(--radius); padding: 30px; box-shadow: var(--shadow); text-align: center;
    }
    .login-logo {
      width: 80px; height: 80px; margin: 0 auto 20px; background-image: url('./logo.png'); background-size: cover; background-position: center;
      border-radius: 20px; border: 3px solid var(--primary);
    }
    .login-title { font-size: 24px; font-weight: 700; color: var(--primary); margin-bottom: 16px; }

    /* App Layout */
    header {
      position: sticky; top: 0; background: #fff; border-bottom: 1px solid var(--border); z-index: 50; padding: 12px 16px;
      display: flex; align-items: center; gap: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .logo {
      width: 195px;
      height: 58px;
      border-radius: 12px;
      background-size: cover;
      background-position: center;
      border: 2px solid var(--primary);
      background-image: url('./logo.png');
    }
    .brand {
      font-weight: 800;
      font-size: 1.2rem;
      color: var(--primary);
    }
    .tabs { display: flex; gap: 8px; margin-left: auto; overflow-x: auto; padding-bottom: 4px; }
    .tab {
      padding: 10px 16px; border-radius: 999px; background: #f1f5f9; color: var(--muted); cursor: pointer; font-size: 14px;
      white-space: nowrap; transition: all 0.2s ease; border: 2px solid transparent;
    }
    .tab:hover { background: #e0e7ff; }
    .tab.active { color: #fff; background: var(--primary); border-color: var(--primary); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }

    main { flex: 1; padding: 16px; display: grid; gap: 16px; }
    .card { background: #fff; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow); overflow: hidden; }
    .card h2 { margin: 0; padding: 14px 16px 12px; font-size: 18px; border-bottom: 1px dashed var(--border); }
    .card .content { padding: 16px; }
    .grid { display: grid; gap: 12px; }
    .g3 { grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 720px) { .g3 { grid-template-columns: repeat(3,1fr); } }

    label { display: block; font-size: 12px; color: var(--muted); margin: 6px 2px 4px; }
    input, select, textarea, button { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid var(--border); background: #fff; color: var(--text); font-size: 14px; }
    textarea { min-height: 80px; resize: vertical; }

    .stack { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 12px; border-radius: 10px;
      border: 1px solid #cbd9f3; background: #f8fbff; color: var(--text); cursor: pointer; font-size: 14px; transition: all 0.2s;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn.primary { background: var(--primary); color: #fff; border-color: var(--primary); }
    .btn.success { background: var(--success); color: #fff; border-color: var(--success); }
    .btn.warn { background: var(--warn); color: #fff; border-color: var(--warn); }
    .btn.danger { background: var(--danger); color: #fff; border-color: var(--danger); }

    /* Dashboard */
    .stats { display: grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 720px) { .stats { grid-template-columns: repeat(4,1fr); } }
    .stat-card { padding: 16px; border-radius: 10px; border: 1px solid var(--border); text-align: center; }
    .stat-card h3 { margin: 0 0 4px; font-size: 14px; color: var(--muted); }
    .stat-card .value { font-size: 20px; font-weight: 700; color: var(--primary); }

    /* Table */
    table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
    th, td { text-align: left; padding: 10px; }
    tr { background: #fff; border: 1px solid var(--border); vertical-align: top; }
    tr td:first-child { border-radius: 8px 0 0 8px; }
    tr td:last-child { border-radius: 0 8px 8px 0; }
    .muted { color: var(--muted); }
    .small { font-size: 13px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .detail { padding: 12px; background: #fbfdff; border-top: 1px dashed var(--border); font-size: 13px; }

    .footerbar {
      position: sticky; bottom: 0; background: #fff; border-top: 1px solid var(--border); padding: 10px 16px;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
    }
    .actions { display: flex; gap: 6px; flex-wrap: wrap; }

    .report-section { display: grid; gap: 12px; margin-bottom: 16px; }
    #report-output { margin-top: 10px; white-space: pre-wrap; background: #f8fafc; padding: 12px; border-radius: 8px; }
  </style>
</head>
<body>

  <div class="login-screen" id="login-screen">
    <div class="login-card">
      <div class="login-logo"></div>
      <h2 class="login-title">PiutangKu</h2>
      <p>Masuk untuk mengelola piutang Anda</p>
      <form id="login-form">
        <div class="grid">
          <div>
            <label>Email</label>
            <input type="email" id="login-email" placeholder="Masukkan email" required />
          </div>
          <div>
            <label>Password</label>
            <input type="password" id="login-password" placeholder="Masukkan password" required />
          </div>
        </div>
        <button type="submit" class="btn primary">Masuk</button>
      </form>
    </div>
  </div>

  <div class="app hidden" id="main-app">

    <header>
      <div class="logo"></div>
      <div class="brand">PiutangKu</div>
      <div class="tabs" role="tablist">
        <div class="tab active" data-tab="dashboard">Dashboard</div>
        <div class="tab" data-tab="create">Tambah Pinjaman</div>
        <div class="tab" data-tab="pay">Pembayaran</div>
        <div class="tab" data-tab="rates">Ubah Bunga</div>
        <div class="tab" data-tab="reports">Laporan</div>
        <div class="tab" data-tab="list">Daftar Pinjaman</div>
      </div>
    </header>

    <main>
      <section class="card" id="tab-dashboard">
        <h2>Dashboard</h2>
        <div class="content">
          <div class="stats">
            <div class="stat-card">
              <h3>Total Pinjaman</h3>
              <div class="value" id="stat-total">Rp0</div>
            </div>
            <div class="stat-card">
              <h3>Sisa Piutang</h3>
              <div class="value" id="stat-outstanding">Rp0</div>
            </div>
            <div class="stat-card">
              <h3>Bunga Terbayar</h3>
              <div class="value" id="stat-interest-paid">Rp0</div>
            </div>
            <div class="stat-card">
              <h3>Jumlah Pembayaran</h3>
              <div class="value" id="stat-payments">0</div>
            </div>
          </div>
        </div>
      </section>

      <section class="card" id="tab-create" hidden>
        <h2>Pinjaman Baru</h2>
        <div class="content">
          <div class="grid g3">
            <div><label>Nama Peminjam</label><input id="c-name" /></div>
            <div><label>Kontak (WA)</label><input id="c-contact" /></div>
            <div><label>Alamat</label><input id="c-address" /></div>
            <div><label>Tanggal Pinjam</label><input id="c-start" type="date" /></div>
            <div><label>Jumlah (Rp)</label><input id="c-principal" type="number" /></div>
            <div><label>Bunga %</label><input id="c-rate" type="number" step="0.01" /></div>
            <div><label>Periode</label><select id="c-period"><option value="daily">Harian</option><option value="monthly">Bulanan</option></select></div>
            <div><label>Tenor (hari)</label><input id="c-tenor" type="number" value="30" /></div>
            <div><label>Metode</label><select id="c-method"><option value="interest_only">Bunga Saja</option><option value="principal_interest">Pokok + Bunga</option></select></div>
            <div style="grid-column:1/-1"><label>Catatan</label><textarea id="c-note"></textarea></div>
          </div>
          <div style="margin-top:16px" class="stack">
            <button class="btn primary" id="btn-create">Simpan Pinjaman</button>
            <button class="btn" id="btn-clear">Bersihkan</button>
          </div>
        </div>
      </section>

      <section class="card" id="tab-pay" hidden>
        <h2>Pembayaran</h2>
        <div class="content">
          <div class="grid g3">
            <div><label>Pilih Pinjaman</label><select id="p-loan"></select></div>
            <div><label>Tanggal Bayar</label><input id="p-date" type="date" /></div>
            <div><label>Nominal (Rp)</label><input id="p-amount" type="number" /></div>
            <div><label>Jenis</label><select id="p-type"><option value="both">Bunga & Pokok</option><option value="interest">Bunga Saja</option><option value="principal">Pokok Saja</option></select></div>
            <div><label>Catatan</label><input id="p-note" /></div>
            <div style="grid-column:1/-1" class="small muted" id="p-dueinfo">—</div>
          </div>
          <div style="margin-top:16px" class="stack">
            <button class="btn success" id="btn-pay">Catat Pembayaran</button>
            <div id="p-breakdown" class="muted small"></div>
          </div>
        </div>
      </section>

      <section class="card" id="tab-rates" hidden>
        <h2>Ubah Bunga</h2>
        <div class="content">
          <div class="grid g3">
            <div><label>Pilih Pinjaman</label><select id="r-loan"></select></div>
            <div><label>Tanggal Berlaku</label><input id="r-date" type="date" /></div>
            <div><label>Bunga Baru (%)</label><input id="r-rate" type="number" step="0.01" /></div>
            <div><label>Catatan</label><input id="r-note" /></div>
          </div>
          <div style="margin-top:16px" class="stack">
            <button class="btn primary" id="btn-rate">Simpan</button>
            <div id="r-history" class="muted small"></div>
          </div>
        </div>
      </section>

      <section class="card" id="tab-reports" hidden>
        <h2>Laporan</h2>
        <div class="content">
          <div class="report-section">
            <div><label>Customer</label><select id="rep-customer"><option value="">Semua</option></select></div>
            <div><label>Dari Tanggal</label><input id="rep-start" type="date" /></div>
            <div><label>Sampai Tanggal</label><input id="rep-end" type="date" /></div>
            <div style="grid-column:1/-1"><button class="btn primary" id="btn-generate-report">Tampilkan</button></div>
          </div>
          <pre id="report-output" class="hidden"></pre>
          <div class="stack" style="margin-top:12px">
            <button class="btn success" id="btn-share-wa">Kirim WhatsApp</button>
            <button class="btn" id="btn-download-pdf">Download PDF</button>
          </div>
        </div>
      </section>

      <section class="card" id="tab-list" hidden>
        <h2>Daftar Pinjaman</h2>
        <div class="content">
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <input id="search" placeholder="Cari..." style="flex:1" />
            <select id="filter-status" style="max-width:180px">
              <option value="all">Semua</option>
              <option value="active">Aktif</option>
              <option value="lunas">Lunas</option>
            </select>
          </div>
          <div style="overflow:auto">
            <table>
              <thead><tr>
                <th>Peminjam</th><th>Sisa Pokok</th><th>Bunga</th><th>Total Bayar</th>
                <th>Status</th><th>Jatuh Tempo</th><th>Aksi</th>
              </tr></thead>
              <tbody id="loan-rows"></tbody>
            </table>
          </div>
          <div class="muted small">Klik baris untuk detail.</div>
        </div>
      </section>

    </main>

    <div class="footerbar">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="muted small">PiutangKu - Aplikasi Piutang</div>
        <div style="margin-left:auto" class="stack">
          <button class="btn" id="btn-logout">Keluar</button>
        </div>
      </div>
    </div>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getAuth, 
      signInWithEmailAndPassword, 
      signOut,
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, doc, getDoc, getDocs, onSnapshot,
      query, orderBy, updateDoc, where, serverTimestamp, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Konfigurasi Firebase (disamarkan)
    const firebaseConfig = {
      apiKey: "AIzaSyDciVnOKpAtRnXdEr-kGPm1tEhStVJw28U",
      authDomain: "piutangku-bfa1a.firebaseapp.com",
      projectId: "piutangku-bfa1a",
      storageBucket: "piutangku-bfa1a.firebasestorage.app",
      messagingSenderId: "238252334346",
      appId: "1:238252334346:web:83ff60aaa7eedb1335eef3"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== UTIL =====
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const todayStr = () => new Date().toISOString().slice(0,10);
    const toISO = d => new Date(d).toISOString().slice(0,10);
    const addDays = (d,n)=>{const t=new Date(d);t.setDate(t.getDate()+n);return toISO(t)};
    const addMonths = (d,n)=>{const t=new Date(d);t.setMonth(t.getMonth()+n);return toISO(t)};
    const fmt = n => Number(n||0).toLocaleString('id-ID');
    function waLink(number, text){ return `https://wa.me/${number}?text=${encodeURIComponent(text)}`; }

    // ===== AUTH SYSTEM =====
    $('#login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = $('#login-email').value.trim();
      const password = $('#login-password').value;
      try { await signInWithEmailAndPassword(auth, email, password); } 
      catch (error) { alert('Login gagal: ' + error.message); }
    });

    $('#btn-logout').addEventListener('click', async () => {
      if (confirm('Yakin ingin keluar?')) { try { await signOut(auth); } catch (error) { console.error('Error signing out:', error); } }
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        $('#login-screen').classList.add('hidden');
        $('#main-app').classList.remove('hidden');
        initApp();
      } else {
        $('#main-app').classList.add('hidden');
        $('#login-screen').classList.remove('hidden');
      }
    });

    // ===== DATA CACHE =====
    let allLoans = [];

    // ===== APP LOGIC & TABS =====
    async function initApp() {
      const tabs = $$('.tab');
      const views = {
        dashboard: $('#tab-dashboard'),
        create: $('#tab-create'),
        pay: $('#tab-pay'),
        rates: $('#tab-rates'),
        reports: $('#tab-reports'),
        list: $('#tab-list')
      };

      tabs.forEach(t => t.addEventListener('click', () => {
        tabs.forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        Object.values(views).forEach(v => v.hidden = true);
        views[t.dataset.tab].hidden = false;
        
        if (t.dataset.tab === 'pay') {
          refreshLoanOptions();
        }
        if (t.dataset.tab === 'reports') {
          refreshCustomerOptions();
        }
      }));

      views.dashboard.hidden = false;
      $('#c-start').value = $('#p-date').value = $('#r-date').value = todayStr();
      $('#rep-start').value = $('#rep-end').value = todayStr();

      onSnapshot(collection(db, 'loans'), async (snap) => {
        allLoans = await Promise.all(snap.docs.map(async d => {
          const loanData = { id: d.id, ...d.data() };
          const paymentsSnap = await getDocs(collection(db, 'loans', d.id, 'payments'));
          loanData.payments = paymentsSnap.docs.map(p => ({id: p.id, ...p.data()}));
          const ratesSnap = await getDocs(collection(db, 'loans', d.id, 'rates'));
          loanData.rateHistory = ratesSnap.docs.map(r => ({id: r.id, ...r.data()}));
          return loanData;
        }));
        loadDashboard();
        refreshLoanOptions();
        refreshCustomerOptions();
        renderList(allLoans);
      });
      
      $('#search').addEventListener('input', () => renderList(allLoans));
      $('#filter-status').addEventListener('change', () => renderList(allLoans));
    }

    // ===== DASHBOARD =====
    async function loadDashboard() {
      const total = allLoans.reduce((s, l) => s + l.principal, 0);
      const outstanding = allLoans.reduce((s, l) => s + l.outstanding, 0);
      const totalInterestPaid = allLoans.reduce((sum, l) => sum + l.payments?.reduce((s, p) => s + p.interestPaid, 0) || 0, 0);
      const totalPaymentsCount = allLoans.reduce((sum, l) => sum + (l.payments?.length || 0), 0);

      $('#stat-total').textContent = 'Rp' + fmt(total);
      $('#stat-outstanding').textContent = 'Rp' + fmt(outstanding);
      $('#stat-interest-paid').textContent = 'Rp' + fmt(totalInterestPaid);
      $('#stat-payments').textContent = totalPaymentsCount;
    }

    // ===== CRUD & HELPERS =====
    async function createLoan(payload) {
      let docRef;
      if (payload.id) {
        docRef = doc(db, 'loans', payload.id);
        await updateDoc(docRef, {
          name: payload.name, contact: payload.contact || '', address: payload.address || '',
          start: payload.start, principal: Number(payload.principal),
          outstanding: Number(payload.principal), method: payload.method,
          period: payload.period, tenor: Number(payload.tenor), note: payload.note || ''
        });
        alert('Pinjaman berhasil diperbarui.');
      } else {
        docRef = await addDoc(collection(db, 'loans'), {
          name: payload.name, contact: payload.contact || '', address: payload.address || '',
          start: payload.start, principal: Number(payload.principal),
          outstanding: Number(payload.principal), method: payload.method,
          period: payload.period, tenor: Number(payload.tenor), note: payload.note || '',
          status: 'active', createdAt: serverTimestamp()
        });
        await addDoc(collection(db, 'loans', docRef.id, 'rates'), {
          date: payload.start, rate: Number(payload.rate), note: 'Bunga awal'
        });
        alert('Pinjaman tersimpan.');
      }
    }

    async function addPayment(loanId, {date, amount, note, type}) {
      const loanRef = doc(db, 'loans', loanId);
      const loanSnap = await getDoc(loanRef);
      const loan = loanSnap.data();

      if (!loan) {
        alert("Pinjaman tidak ditemukan.");
        return;
      }

      const paymentsSnap = await getDocs(collection(db, 'loans', loanId, 'payments'));
      const payments = paymentsSnap.docs.map(p => p.data());
      const lastPaymentDate = payments.length > 0 ? payments[payments.length - 1].date : loan.start;

      const interestAccrued = calcInterestDue(loan, lastPaymentDate, date);
      let interestPaid = 0;
      let principalPaid = 0;
      let paymentAmount = Number(amount);
      
      if (paymentAmount <= 0) {
        alert("Nominal pembayaran harus lebih dari 0.");
        return;
      }
      
      if (type === 'interest' || type === 'both') {
          interestPaid = Math.min(paymentAmount, interestAccrued);
          paymentAmount -= interestPaid;
      }

      if (type === 'principal' || (type === 'both' && paymentAmount > 0)) {
          principalPaid = Math.min(paymentAmount, loan.outstanding);
      }

      const newOutstanding = Math.max(0, loan.outstanding - principalPaid);
      const newStatus = newOutstanding <= 0 ? 'lunas' : 'active';

      await addDoc(collection(db, 'loans', loanId, 'payments'), {
          date,
          amount: Number(amount),
          interestPaid,
          principalPaid,
          note,
          createdAt: serverTimestamp()
      });

      await updateDoc(loanRef, {
          outstanding: newOutstanding,
          status: newStatus
      });

      alert(`Pembayaran berhasil. Dibayar: Bunga Rp${fmt(interestPaid)}, Pokok Rp${fmt(principalPaid)}`);
    }
    
    // Fungsi untuk pratinjau pembayaran
    function previewPayment() {
      const id = $('#p-loan').value;
      const amount = Number($('#p-amount').value) || 0;
      const type = $('#p-type').value;

      if (!id || amount === 0) {
        $('#p-breakdown').textContent = "";
        return;
      }

      const loan = allLoans.find(l => l.id === id);
      const lastPaymentDate = loan.payments.length > 0 ? loan.payments[loan.payments.length - 1].date : loan.start;
      const interestAccrued = calcInterestDue(loan, lastPaymentDate, todayStr());
      let interestPaid = 0;
      let principalPaid = 0;
      let remaining = amount;

      if (type === 'interest' || type === 'both') {
        interestPaid = Math.min(remaining, interestAccrued);
        remaining -= interestPaid;
      }

      if (type === 'principal' || (type === 'both' && remaining > 0)) {
        principalPaid = Math.min(remaining, loan.outstanding);
      }

      $('#p-breakdown').innerHTML = `
        <p><b>Pratinjau Pembayaran</b></p>
        <p>Bunga Terutang: Rp${fmt(interestAccrued)}</p>
        <p>Pembayaran akan dialokasikan sebagai:</p>
        <ul>
            <li>Bunga: Rp${fmt(interestPaid)}</li>
            <li>Pokok: Rp${fmt(principalPaid)}</li>
        </ul>
        <p>Sisa Pokok setelah pembayaran: Rp${fmt(loan.outstanding - principalPaid)}</p>
      `;
    }

    function calcInterestDue(loan, fromDate, toDate) {
      if (loan.outstanding <= 0) return 0;
      
      const dailyRate = (rateAt(loan, fromDate) / 100) / 30;
      const from = new Date(fromDate);
      const to = new Date(toDate);
      const diffTime = to.getTime() - from.getTime();
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays <= 0) return 0;

      const interest = loan.outstanding * dailyRate * diffDays;
      return +interest.toFixed(2);
    }

    function rateAt(loan, date) {
      if (loan.rateHistory && loan.rateHistory.length > 0) {
        const history = [...loan.rateHistory].sort((a, b) => new Date(a.date) - new Date(b.date));
        const activeRate = history.find(r => new Date(r.date) <= new Date(date)) || history[0];
        return activeRate ? activeRate.rate : 0;
      }
      return loan.rate || 0;
    }

    function nextDueDate(loan) {
      const start = new Date(loan.start);
      const tenorDays = loan.tenor || 30;
      const nextDue = new Date(start);
      nextDue.setDate(start.getDate() + tenorDays);
      return toISO(nextDue);
    }

    async function deleteLoan(id) {
        if (!confirm('Apakah Anda yakin ingin menghapus pinjaman ini?')) return;
        await deleteDoc(doc(db, 'loans', id));
        alert('Pinjaman berhasil dihapus.');
    }

    async function editLoan(id) {
        const loan = allLoans.find(l => l.id === id);
        if (!loan) return;
        
        $('#c-name').value = loan.name;
        $('#c-contact').value = loan.contact;
        $('#c-address').value = loan.address;
        $('#c-start').value = loan.start;
        $('#c-principal').value = loan.principal;
        $('#c-rate').value = loan.rateHistory?.length ? loan.rateHistory[loan.rateHistory.length-1].rate : 0;
        $('#c-period').value = loan.period;
        $('#c-tenor').value = loan.tenor;
        $('#c-method').value = loan.method;
        $('#c-note').value = loan.note;

        $('#btn-create').textContent = 'Perbarui Pinjaman';
        $('#btn-create').onclick = async () => {
            await createLoan({...getCreateFormValues(), id: loan.id});
        };
        
        document.querySelector('[data-tab="create"]').click();
    }

    function getCreateFormValues() {
        return {
            name: $('#c-name').value, contact: $('#c-contact').value, address: $('#c-address').value,
            start: $('#c-start').value, principal: Number($('#c-principal').value),
            method: $('#c-method').value, period: $('#c-period').value,
            tenor: Number($('#c-tenor').value), rate: Number($('#c-rate').value), note: $('#c-note').value
        };
    }

    // ===== UI FUNCTIONS =====
    async function refreshLoanOptions() {
      const opts = allLoans.map(d => {
        return `<option value="${d.id}">${d.name} — Rp${fmt(d.outstanding)}</option>`;
      }).join('');
      $('#p-loan').innerHTML = '<option value="">— pilih —</option>' + opts;
      $('#r-loan').innerHTML = '<option value="">— pilih —</option>' + opts;
    }

    async function refreshCustomerOptions() {
      const seen = new Set();
      const opts = [];
      allLoans.forEach(l => {
        if (!seen.has(l.name)) {
          seen.add(l.name);
          opts.push(`<option value="${l.name}">${l.name}</option>`);
        }
      });
      $('#rep-customer').innerHTML = '<option value="">Semua Customer</option>' + opts.join('');
    }

    function renderList(loans) {
      const q = ($('#search').value || '').toLowerCase();
      const st = $('#filter-status').value;
      const filtered = loans.filter(l => {
        const matchQ = !q || l.name.toLowerCase().includes(q) || (l.contact||'').includes(q);
        const matchS = st === 'all' || l.status === st;
        return matchQ && matchS;
      });

      let rows = '';
      for (const l of filtered) {
        const lastPayDate = l.payments?.length > 0 ? l.payments[l.payments.length-1].date : l.start;
        const accInt = calcInterestDue(l, lastPayDate, todayStr());
        const totalPaid = l.payments?.reduce((s,p)=>s+p.amount,0) || 0;
        const status = l.status === 'lunas' ? 'Lunas' : 'Aktif';
        rows += `
          <tr data-id="${l.id}">
            <td><b>${l.name}</b><div class="muted small">${l.contact||''}</div></td>
            <td class="mono">Rp${fmt(l.outstanding)}</td>
            <td class="mono">Rp${fmt(accInt)}</td>
            <td class="mono">Rp${fmt(totalPaid)}</td>
            <td>${status}</td>
            <td>${l.tenor} hari</td>
            <td>
              <button class="btn" onclick="editLoan('${l.id}');event.stopPropagation()">Edit</button>
              <button class="btn danger" onclick="deleteLoan('${l.id}');event.stopPropagation()">Hapus</button>
            </td>
          </tr>`;
      }
      $('#loan-rows').innerHTML = rows || '<tr><td colspan="7">Tidak ada data</td></tr>';
    }
    
    // ===== REPORTS =====
    $('#btn-generate-report').addEventListener('click', async () => {
      const customer = $('#rep-customer').value;
      const start = $('#rep-start').value;
      const end = $('#rep-end').value;
      
      let report = `LAPORAN PIUTANG\n`;
      let totalPrincipal = 0, totalPaid = 0, totalOutstanding = 0, totalInterestPaid = 0;

      const filteredLoans = allLoans.filter(l => !customer || l.name === customer);

      if (customer) {
          const loan = filteredLoans[0];
          report += `Customer: ${loan.name}\n\n`;
          report += `RINCIAN PEMBAYARAN\n`;
          report += `------------------------------\n`;
          report += `Pokok Awal: Rp${fmt(loan.principal)}\n`;
          report += `Sisa Pokok: Rp${fmt(loan.outstanding)}\n\n`;
          
          if (loan.payments?.length) {
              const paymentsInPeriod = loan.payments.filter(p => p.date >= start && p.date <= end);
              paymentsInPeriod.forEach(p => {
                  report += `Tanggal: ${p.date}\n`;
                  report += `Nominal Bayar: Rp${fmt(p.amount)}\n`;
                  report += `Bunga Terbayar: Rp${fmt(p.interestPaid)}\n`;
                  report += `Pokok Terbayar: Rp${fmt(p.principalPaid)}\n\n`;
              });
          }
      } else {
          report += `Dari: ${start} s/d ${end}\n`;
          report += `\nRINGKASAN PINJAMAN\n`;
          report += `------------------------------\n`;

          for (const l of filteredLoans) {
              const paymentsInPeriod = l.payments.filter(p => p.date >= start && p.date <= end);
              const paidInPeriod = paymentsInPeriod.reduce((s,x)=>s+x.amount,0);
              const interestInPeriod = paymentsInPeriod.reduce((s,x)=>s+x.interestPaid,0);

              report += `\nNama: ${l.name}\n`;
              report += `Pokok Awal: Rp${fmt(l.principal)}\n`;
              report += `Sisa Piutang: Rp${fmt(l.outstanding)}\n`;
              report += `Bayar Periode Ini: Rp${fmt(paidInPeriod)}\n`;
              report += `Bunga Terbayar Periode Ini: Rp${fmt(interestInPeriod)}\n`;

              totalPrincipal += l.principal;
              totalPaid += paidInPeriod;
              totalOutstanding += l.outstanding;
              totalInterestPaid += interestInPeriod;
          }

          report += `\n--- TOTAL KESELURUHAN ---\n`;
          report += `Pokok Awal: Rp${fmt(totalPrincipal)}\n`;
          report += `Total Terbayar Periode: Rp${fmt(totalPaid)}\n`;
          report += `Total Bunga Terbayar Periode: Rp${fmt(totalInterestPaid)}\n`;
          report += `Total Sisa Piutang: Rp${fmt(totalOutstanding)}`;
      }

      $('#report-output').textContent = report;
      $('#report-output').classList.remove('hidden');
    });
    
    window.editLoan = editLoan;
    window.deleteLoan = deleteLoan;

    // ===== BUTTONS =====
    $('#btn-create').onclick = async () => {
      const name = $('#c-name').value;
      if (!name || !$('#c-principal').value) return alert('Isi nama dan jumlah');
      await createLoan(getCreateFormValues());
    };

    $('#btn-pay').onclick = async () => {
      const id = $('#p-loan').value;
      const amount = $('#p-amount').value;
      if (!id || !amount) return alert('Pilih pinjaman & nominal');
      await addPayment(id, {
        date: $('#p-date').value,
        amount,
        note: $('#p-note').value,
        type: $('#p-type').value
      });
    };

    $('#p-loan, #p-amount, #p-date, #p-type').addEventListener('change', previewPayment);
    $('#p-amount, #p-date').addEventListener('input', previewPayment);

    $('#btn-rate').onclick = async () => {
      const id = $('#r-loan').value;
      if (!id || !$('#r-rate').value) return alert('Lengkapi data');
      await addDoc(collection(db, 'loans', id, 'rates'), {
        date: $('#r-date').value,
        rate: Number($('#r-rate').value),
        note: $('#r-note').value
      });
      alert('Bunga diubah');
    };

    // ===== PWA =====
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(() => {});
    }
  </script>
</body>
</html>
