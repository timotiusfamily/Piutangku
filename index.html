<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PiutangKu - Aplikasi Piutang</title>

  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#2563eb" />

  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --bg: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e6eef9;
      --primary: #2563eb;
      --success: #16a34a;
      --warn: #f59e0b;
      --danger: #dc2626;
      --radius: 14px;
      --shadow: 0 6px 24px rgba(2,6,23,.06);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font: 500 15px/1.6 system-ui, Roboto, 'Segoe UI', Arial; }

    .app { max-width: 980px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; }
    .hidden { display: none !important; }

    /* Login Screen */
    .login-screen {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      min-height: 100vh; padding: 20px; background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
    }
    .login-card {
      width: 100%; max-width: 400px; background: #fff; border-radius: var(--radius); padding: 30px; box-shadow: var(--shadow); text-align: center;
    }
    .login-logo {
      width: 80px; height: 80px; margin: 0 auto 20px; background-image: url('./logo.png'); background-size: cover; background-position: center;
      border-radius: 20px; border: 3px solid var(--primary);
    }
    .login-title { font-size: 24px; font-weight: 700; color: var(--primary); margin-bottom: 16px; }

    /* App Layout */
    header {
      position: sticky; top: 0; background: #fff; border-bottom: 1px solid var(--border); z-index: 50; padding: 12px 16px;
      display: flex; align-items: center; gap: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .logo {
      width: 95px;
      height: 70px;
      border-radius: 12px;
      background-size: cover;
      background-position: center;
      border: 2px solid var(--primary);
      background-image: url('./logo.png');
    }
    .brand {
      font-weight: 800;
      font-size: 1.2rem;
      color: var(--primary);
    }

    /* Tab Bar */
    .tab-bar {
      display: flex;
      background: #fff;
      border-bottom: 1px solid var(--border);
      padding: 8px 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      overflow-x: auto;
      white-space: nowrap;
      scrollbar-width: thin;
      scrollbar-color: var(--primary) #f1f5f9;
    }
    .tab-bar::-webkit-scrollbar { height: 8px; }
    .tab-bar::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; }
    .tab-bar::-webkit-scrollbar-track { background: #f1f5f9; }

    .tabs {
      display: inline-flex;
      gap: 8px;
      margin: 0 auto;
      padding: 0 8px;
    }
    .tab {
      padding: 10px 16px;
      border-radius: 999px;
      background: #f1f5f9;
      color: var(--muted);
      cursor: pointer;
      font-size: 14px;
      white-space: nowrap;
      transition: all 0.2s ease;
      border: 2px solid transparent;
      flex-shrink: 0;
    }
    .tab:hover { background: #e0e7ff; }
    .tab.active { color: #fff; background: var(--primary); border-color: var(--primary); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }

    main { flex: 1; padding: 13px; display: grid; gap: 12px; }
    .card { background: #fff; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow); overflow: hidden; }
    .card h2 { margin: 0; padding: 14px 16px 12px; font-size: 18px; border-bottom: 1px dashed var(--border); }
    .card .content { padding: 12px; }
    .grid { display: grid; gap: 12px; }
    .g3 { grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 720px) { .g3 { grid-template-columns: repeat(3,1fr); } }

    label { display: block; font-size: 12px; color: var(--muted); margin: 6px 2px 4px; }
    input, select, textarea, button { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid var(--border); background: #fff; color: var(--text); font-size: 14px; }
    textarea { min-height: 80px; resize: vertical; }

    .stack { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 12px; border-radius: 10px;
      border: 1px solid #cbd9f3; background: #f8fbff; color: var(--text); cursor: pointer; font-size: 14px; transition: all 0.2s;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn.primary { background: var(--primary); color: #fff; border-color: var(--primary); }
    .btn.success { background: var(--success); color: #fff; border-color: var(--success); }
    .btn.warn { background: var(--warn); color: #fff; border-color: var(--warn); }
    .btn.danger { background: var(--danger); color: #fff; border-color: var(--danger); }

    .stats { display: grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 720px) { .stats { grid-template-columns: repeat(4,1fr); } }
    .stat-card { padding: 16px; border-radius: 10px; border: 1px solid var(--border); text-align: center; }
    .stat-card h3 { margin: 0 0 4px; font-size: 14px; color: var(--muted); }
    .stat-card .value { font-size: 20px; font-weight: 700; color: var(--primary); }

    table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
    th, td { text-align: left; padding: 10px; }
    tr { background: #fff; border: 1px solid var(--border); vertical-align: top; }
    tr td:first-child { border-radius: 8px 0 0 8px; }
    tr td:last-child { border-radius: 0 8px 8px 0; }
    .muted { color: var(--muted); }
    .small { font-size: 13px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .detail { padding: 12px; background: #fbfdff; border-top: 1px dashed var(--border); font-size: 13px; }

    .footerbar {
      position: sticky; bottom: 0; background: #fff; border-top: 1px solid var(--border); padding: 10px 16px;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
    }
    .actions { display: flex; gap: 6px; flex-wrap: wrap; }

    .report-section { display: grid; gap: 12px; margin-bottom: 16px; }
    #report-output { margin-top: 10px; white-space: pre-wrap; background: #f8fafc; padding: 12px; border-radius: 8px; }
  </style>
</head>
<body>

  <div class="login-screen" id="login-screen">
    <div class="login-card">
      <div class="login-logo"></div>
      <h2 class="login-title">PiutangKu</h2>
      <p>Masuk untuk mengelola piutang Anda</p>
      <form id="login-form">
        <div class="grid">
          <div>
            <label>Email</label>
            <input type="email" id="login-email" placeholder="Masukkan email" required />
          </div>
          <div>
            <label>Password</label>
            <input type="password" id="login-password" placeholder="Masukkan password" required />
          </div>
        </div>
        <button type="submit" class="btn primary">Masuk</button>
      </form>
    </div>
  </div>

  <div class="app hidden" id="main-app">

    <header>
      <div class="logo"></div>
      <div class="brand">PiutangKu</div>
    </header>

    <div class="tab-bar">
      <div class="tabs" role="tablist">
        <div class="tab active" data-tab="dashboard">Dashboard</div>
        <div class="tab" data-tab="create">Tambah Pinjaman</div>
        <div class="tab" data-tab="pay">Pembayaran</div>
        <div class="tab" data-tab="rates">Ubah Bunga</div>
        <div class="tab" data-tab="reports">Laporan</div>
        <div class="tab" data-tab="list">Daftar Pinjaman</div>
      </div>
    </div>

    <main>
      <section class="card" id="tab-dashboard">
        <h2>Dashboard</h2>
        <div class="content">
          <div class="stats">
            <div class="stat-card">
              <h3>Total Pinjaman</h3>
              <div class="value" id="stat-total">Rp0</div>
            </div>
            <div class="stat-card">
              <h3>Sisa Piutang</h3>
              <div class="value" id="stat-outstanding">Rp0</div>
            </div>
            <div class="stat-card">
              <h3>Bunga Terbayar</h3>
              <div class="value" id="stat-interest-paid">Rp0</div>
            </div>
            <div class="stat-card">
              <h3>Jumlah Pembayaran</h3>
              <div class="value" id="stat-payments">0</div>
            </div>
          </div>
        </div>
      </section>

      <section class="card" id="tab-create" hidden>
        <h2>Pinjaman Baru</h2>
        <div class="content">
          <div class="grid g3">
            <div><label>Nama Peminjam</label><input id="c-name" /></div>
            <div><label>Kontak (WA)</label><input id="c-contact" /></div>
            <div><label>Alamat</label><input id="c-address" /></div>
            <div><label>Tanggal Pinjam</label><input id="c-start" type="date" /></div>
            <div><label>Jumlah (Rp)</label><input id="c-principal" type="number" /></div>
            <div><label>Bunga %</label><input id="c-rate" type="number" step="0.01" /></div>
            <div><label>Periode Bunga</label><select id="c-period"><option value="daily">Harian</option><option value="monthly">Bulanan</option></select></div>
            <div>
              <label>Tenor</label>
              <div style="display:flex;gap:8px">
                <input id="c-tenor-value" type="number" value="30" placeholder="Nilai" />
                <select id="c-tenor-unit"><option value="days">Hari</option><option value="months">Bulan</option></select>
              </div>
            </div>
            <div><label>Metode</label><select id="c-method"><option value="interest_only">Bunga Saja</option><option value="principal_interest">Pokok + Bunga</option></select></div>
            <div style="grid-column:1/-1"><label>Catatan</label><textarea id="c-note"></textarea></div>
          </div>
          <div style="margin-top:16px" class="stack">
            <button class="btn primary" id="btn-create">Simpan Pinjaman</button>
            <button class="btn" id="btn-clear">Bersihkan</button>
          </div>
        </div>
      </section>

      <section class="card" id="tab-pay" hidden>
        <h2>Pembayaran</h2>
        <div class="content">
          <div class="grid g3">
            <div><label>Pilih Pinjaman</label><select id="p-loan"></select></div>
            <div><label>Tanggal Bayar</label><input id="p-date" type="date" /></div>
            <div><label>Nominal (Rp)</label><input id="p-amount" type="number" /></div>
            <div><label>Jenis</label><select id="p-type"><option value="both">Bunga & Pokok</option><option value="interest">Bunga Saja</option><option value="principal">Pokok Saja</option></select></div>
            <div><label>Catatan</label><input id="p-note" /></div>
            <div style="grid-column:1/-1" class="small muted" id="p-dueinfo">—</div>
          </div>
          <div style="margin-top:16px" class="stack">
            <button class="btn success" id="btn-pay">Catat Pembayaran</button>
            <pre id="p-breakdown" class="small muted hidden" style="background: #f8fafc; padding: 12px; border-radius: 8px;"></pre>
          </div>
        </div>
      </section>

      <section class="card" id="tab-rates" hidden>
        <h2>Ubah Bunga</h2>
        <div class="content">
          <div class="grid g3">
            <div><label>Pilih Pinjaman</label><select id="r-loan"></select></div>
            <div><label>Tanggal Berlaku</label><input id="r-date" type="date" /></div>
            <div><label>Bunga Baru (%)</label><input id="r-rate" type="number" step="0.01" /></div>
            <div><label>Catatan</label><input id="r-note" /></div>
          </div>
          <div style="margin-top:16px" class="stack">
            <button class="btn primary" id="btn-rate">Simpan</button>
            <div id="r-history" class="muted small"></div>
          </div>
        </div>
      </section>

      <section class="card" id="tab-reports" hidden>
        <h2>Laporan</h2>
        <div class="content">
          <div class="report-section">
            <div><label>Customer</label><select id="rep-customer"><option value="">Semua</option></select></div>
            <div><label>Dari Tanggal</label><input id="rep-start" type="date" /></div>
            <div><label>Sampai Tanggal</label><input id="rep-end" type="date" /></div>
            <div style="grid-column:1/-1"><button class="btn primary" id="btn-generate-report">Tampilkan</button></div>
          </div>
          <pre id="report-output" class="hidden"></pre>
          <div class="stack" style="margin-top:12px">
            <button class="btn success" id="btn-share-wa">Kirim WhatsApp</button>
            <button class="btn" id="btn-download-pdf">Download PDF</button>
          </div>
        </div>
      </section>

      <section class="card" id="tab-list" hidden>
        <h2>Daftar Pinjaman</h2>
        <div class="content">
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <input id="search" placeholder="Cari..." style="flex:1" />
            <select id="filter-status" style="max-width:180px">
              <option value="all">Semua</option>
              <option value="active">Aktif</option>
              <option value="lunas">Lunas</option>
            </select>
          </div>
          <div style="overflow:auto">
            <table>
              <thead><tr>
                <th>Peminjam</th><th>Sisa Pokok</th><th>Bunga</th><th>Total Bayar</th>
                <th>Status</th><th>Jatuh Tempo</th><th>Aksi</th>
              </tr></thead>
              <tbody id="loan-rows"></tbody>
            </table>
          </div>
          <div class="muted small">Klik baris untuk detail.</div>
        </div>
      </section>
    </main>

    <div class="footerbar">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="muted small">PiutangKu - Aplikasi Piutang</div>
        <div style="margin-left:auto" class="stack">
          <button class="btn" id="btn-logout">Keluar</button>
        </div>
      </div>
    </div>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getAuth, 
      signInWithEmailAndPassword, 
      signOut,
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, doc, getDoc, getDocs, onSnapshot,
      query, orderBy, updateDoc, where, serverTimestamp, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDciVnOKpAtRnXdEr-kGPm1tEhStVJw28U",
      authDomain: "piutangku-bfa1a.firebaseapp.com",
      projectId: "piutangku-bfa1a",
      storageBucket: "piutangku-bfa1a.firebasestorage.app",
      messagingSenderId: "238252334346",
      appId: "1:238252334346:web:83ff60aaa7eedb1335eef3"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const todayStr = () => new Date().toISOString().slice(0,10);
    const toISO = d => new Date(d).toISOString().slice(0,10);
    const fmt = n => Number(n||0).toLocaleString('id-ID');
    function waLink(number, text){ return `https://wa.me/${number}?text=${encodeURIComponent(text)}`; }

    // ===== AUTH SYSTEM =====
    $('#login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = $('#login-email').value.trim();
      const password = $('#login-password').value;
      try { await signInWithEmailAndPassword(auth, email, password); } 
      catch (error) { alert('Login gagal: ' + error.message); }
    });

    $('#btn-logout').addEventListener('click', async () => {
      if (confirm('Yakin ingin keluar?')) { try { await signOut(auth); } catch (error) { console.error('Error signing out:', error); } }
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        $('#login-screen').classList.add('hidden');
        $('#main-app').classList.remove('hidden');
        initApp();
      } else {
        $('#main-app').classList.add('hidden');
        $('#login-screen').classList.remove('hidden');
      }
    });

    let allLoans = [];

    async function initApp() {
      const tabs = $$('.tab');
      const views = {
        dashboard: $('#tab-dashboard'),
        create: $('#tab-create'),
        pay: $('#tab-pay'),
        rates: $('#tab-rates'),
        reports: $('#tab-reports'),
        list: $('#tab-list')
      };

      tabs.forEach(t => t.addEventListener('click', () => {
        tabs.forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        Object.values(views).forEach(v => v.hidden = true);
        views[t.dataset.tab].hidden = false;
        t.scrollIntoView({ behavior: 'smooth', inline: 'center' });
        if (t.dataset.tab === 'pay') refreshLoanOptions();
        if (t.dataset.tab === 'rates') refreshLoanOptions();
        if (t.dataset.tab === 'reports') refreshCustomerOptions();
      }));

      views.dashboard.hidden = false;
      tabs.find(t => t.dataset.tab === 'dashboard').classList.add('active');
      tabs.find(t => t.dataset.tab === 'dashboard').scrollIntoView();

      $('#c-start').value = $('#p-date').value = $('#r-date').value = todayStr();
      $('#rep-start').value = $('#rep-end').value = todayStr();

      onSnapshot(collection(db, 'loans'), async (snap) => {
        allLoans = await Promise.all(snap.docs.map(async d => {
          const loanData = { id: d.id, ...d.data() };
          const paymentsSnap = await getDocs(query(collection(db, 'loans', d.id, 'payments'), orderBy('date')));
          loanData.payments = paymentsSnap.docs.map(p => ({id: p.id, ...p.data()}));
          const ratesSnap = await getDocs(query(collection(db, 'loans', d.id, 'rates'), orderBy('date')));
          loanData.rateHistory = ratesSnap.docs.map(r => ({id: r.id, ...r.data()}));
          return loanData;
        }));
        loadDashboard();
        refreshLoanOptions();
        refreshCustomerOptions();
        renderList(allLoans);
      });

      $('#p-loan').addEventListener('change', (e) => {
        const loanId = e.target.value;
        if (loanId) {
          const loan = allLoans.find(l => l.id === loanId);
          if (loan) {
            const sortedPayments = [...loan.payments].sort((a, b) => new Date(a.date) - new Date(b.date));
            const lastPaymentDate = sortedPayments.length > 0 ? sortedPayments[sortedPayments.length - 1].date : loan.start;
            const interestAccrued = calcInterestDue(loan, lastPaymentDate, todayStr());
            $('#p-dueinfo').textContent = `Bunga terutang sampai hari ini: Rp${fmt(interestAccrued)}`;
          }
        } else {
          $('#p-dueinfo').textContent = '—';
        }
      });
    }

    function loadDashboard() {
      const total = allLoans.reduce((s, l) => s + l.principal, 0);
      const outstanding = allLoans.reduce((s, l) => s + l.outstanding, 0);
      const totalInterestPaid = allLoans.reduce((sum, l) => sum + (l.payments?.reduce((s, p) => s + p.interestPaid, 0) || 0), 0);
      const totalPaymentsCount = allLoans.reduce((sum, l) => sum + (l.payments?.length || 0), 0);

      $('#stat-total').textContent = 'Rp' + fmt(total);
      $('#stat-outstanding').textContent = 'Rp' + fmt(outstanding);
      $('#stat-interest-paid').textContent = 'Rp' + fmt(totalInterestPaid);
      $('#stat-payments').textContent = totalPaymentsCount;
    }

    // ===== PERHITUNGAN BUNGA DENGAN HARIAN & BULANAN (REVISI) =====
    function calcInterestDue(loan, fromDate, toDate) {
      if (!loan || loan.outstanding <= 0 || !fromDate || !toDate) return 0;

      let totalInterest = 0;
      const from = new Date(fromDate);
      const to = new Date(toDate);
      
      if (to < from) return 0;

      // Mendapatkan riwayat bunga yang relevan
      const relevantRates = [...loan.rateHistory]
        .filter(r => new Date(r.date) < to)
        .sort((a, b) => new Date(a.date) - new Date(b.date));
      
      const initialRateDate = relevantRates[0] ? new Date(relevantRates[0].date) : new Date(loan.start);
      const startCalcDate = new Date(Math.max(from, initialRateDate));

      let currentCalcDate = new Date(startCalcDate);
      const endCalcDate = new Date(to);

      while (currentCalcDate <= endCalcDate) {
        const nextRateChange = relevantRates.find(r => new Date(r.date) > currentCalcDate);
        const endPeriodDate = nextRateChange ? new Date(nextRateChange.date) : endCalcDate;
        
        const periodEndDate = new Date(Math.min(endPeriodDate, endCalcDate));

        const rate = rateAt(loan, toISO(currentCalcDate));
        if (rate <= 0) break;

        const principal = loan.outstanding;

        if (loan.period === 'daily') {
          const diffTime = periodEndDate.getTime() - currentCalcDate.getTime();
          const diffDays = Math.max(0, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
          const dailyRate = rate / 100;
          totalInterest += principal * dailyRate * diffDays;
        } else if (loan.period === 'monthly') {
          let months = (periodEndDate.getFullYear() - currentCalcDate.getFullYear()) * 12;
          months -= currentCalcDate.getMonth();
          months += periodEndDate.getMonth();
          months = Math.max(0, months);
          const monthlyRate = rate / 100;
          totalInterest += principal * monthlyRate * months;
        }
        
        if (currentCalcDate >= endCalcDate) break;
        currentCalcDate = periodEndDate;
      }

      return Math.round(totalInterest * 100) / 100;
    }

    function rateAt(loan, date) {
      if (!loan.rateHistory || loan.rateHistory.length === 0) return loan.rate || 0;
      const history = [...loan.rateHistory].sort((a, b) => new Date(a.date) - new Date(b.date));
      let activeRate = history[0].rate;
      for (const r of history) {
        if (new Date(r.date) <= new Date(date)) {
          activeRate = r.rate;
        } else break;
      }
      return activeRate;
    }

    async function createLoan(payload) {
      const data = {
        name: payload.name,
        contact: payload.contact || '',
        address: payload.address || '',
        start: payload.start,
        principal: Number(payload.principal),
        outstanding: Number(payload.principal),
        method: payload.method,
        period: payload.period,
        tenorValue: Number(payload.tenorValue),
        tenorUnit: payload.tenorUnit,
        note: payload.note || '',
        createdAt: serverTimestamp()
      };

      if (payload.id) {
        await updateDoc(doc(db, 'loans', payload.id), data);
        alert('Pinjaman berhasil diperbarui.');
      } else {
        const docRef = await addDoc(collection(db, 'loans'), {
          ...data,
          status: 'active'
        });
        await addDoc(collection(db, 'loans', docRef.id, 'rates'), {
          date: payload.start,
          rate: Number(payload.rate),
          note: 'Bunga awal'
        });
        alert('Pinjaman tersimpan.');
      }
      $('#btn-create').textContent = 'Simpan Pinjaman';
    }

    // ===== LOGIKA PEMBAYARAN BARU =====
    async function addPayment(loanId, { date, amount, note, type }) {
      const loanRef = doc(db, 'loans', loanId);
      const loanSnap = await getDoc(loanRef);
      if (!loanSnap.exists()) return alert("Pinjaman tidak ditemukan.");

      const loan = allLoans.find(l => l.id === loanId);
      if (!loan) return;

      const sortedPayments = [...loan.payments].sort((a, b) => new Date(a.date) - new Date(b.date));
      const lastPaymentDate = sortedPayments.length > 0 ? sortedPayments[sortedPayments.length - 1].date : loan.start;

      const interestAccrued = calcInterestDue(loan, lastPaymentDate, date);
      let interestPaid = 0, principalPaid = 0;
      let remaining = Number(amount);

      if (type === 'interest') {
        interestPaid = Math.min(remaining, interestAccrued);
      } else if (type === 'principal') {
        principalPaid = Math.min(remaining, loan.outstanding);
      } else { // type === 'both'
        interestPaid = Math.min(remaining, interestAccrued);
        remaining -= interestPaid;
        principalPaid = Math.min(remaining, loan.outstanding);
      }

      const newOutstanding = Math.max(0, loan.outstanding - principalPaid);
      const newStatus = newOutstanding <= 0 ? 'lunas' : 'active';

      await addDoc(collection(db, 'loans', loanId, 'payments'), {
        date,
        amount: Number(amount),
        interestPaid,
        principalPaid,
        note,
        createdAt: serverTimestamp()
      });

      await updateDoc(loanRef, { outstanding: newOutstanding, status: newStatus });
      
      updatePaymentBreakdown(date, amount, interestAccrued, interestPaid, principalPaid, newOutstanding, newStatus);
      alert(`Pembayaran berhasil. Bunga: Rp${fmt(interestPaid)}, Pokok: Rp${fmt(principalPaid)}`);
    }

    function updatePaymentBreakdown(date, amount, interestAccrued, interestPaid, principalPaid, newOutstanding, newStatus) {
      const breakdown = `
RINCIAN PEMBAYARAN
Tanggal: ${date}
Nominal: Rp${fmt(amount)}
Bunga Terutang: Rp${fmt(interestAccrued)}
Bunga Dibayar: Rp${fmt(interestPaid)}
Pokok Dibayar: Rp${fmt(principalPaid)}
Sisa Pokok: Rp${fmt(newOutstanding)}
Status: ${newStatus.toUpperCase()}
      `;
      $('#p-breakdown').textContent = breakdown;
      $('#p-breakdown').classList.remove('hidden');
    }

    function getDueDate(loan) {
      const start = new Date(loan.start);
      if (loan.tenorUnit === 'days') {
        const due = new Date(start);
        due.setDate(due.getDate() + loan.tenorValue);
        return toISO(due);
      } else if (loan.tenorUnit === 'months') {
        const due = new Date(start);
        due.setMonth(due.getMonth() + loan.tenorValue);
        return toISO(due);
      }
      return '—';
    }

    function refreshLoanOptions() {
      const opts = allLoans.map(l => {
        const sortedPayments = [...l.payments].sort((a, b) => new Date(a.date) - new Date(b.date));
        const lastPaymentDate = sortedPayments.length > 0 ? sortedPayments[sortedPayments.length - 1].date : l.start;
        const interestAccrued = calcInterestDue(l, lastPaymentDate, todayStr());
        return `<option value="${l.id}">${l.name} — Sisa: Rp${fmt(l.outstanding)}, Bunga: Rp${fmt(interestAccrued)}</option>`;
      }).join('');
      $('#p-loan').innerHTML = '<option value="">— pilih —</option>' + opts;
      $('#r-loan').innerHTML = '<option value="">— pilih —</option>' + opts;
    }

    function refreshCustomerOptions() {
      const seen = new Set();
      const opts = [];
      allLoans.forEach(l => {
        if (!seen.has(l.name)) {
          seen.add(l.name);
          opts.push(`<option value="${l.name}">${l.name}</option>`);
        }
      });
      $('#rep-customer').innerHTML = '<option value="">Semua Customer</option>' + opts.join('');
    }

    function renderList(loans) {
      const q = ($('#search').value || '').toLowerCase();
      const st = $('#filter-status').value;
      const filtered = loans.filter(l => {
        const matchQ = !q || l.name.toLowerCase().includes(q) || (l.contact||'').includes(q);
        const matchS = st === 'all' || l.status === st;
        return matchQ && matchS;
      });

      let rows = '';
      for (const l of filtered) {
        const lastPayDate = l.payments?.length > 0 ? l.payments[l.payments.length-1].date : l.start;
        const accInt = calcInterestDue(l, lastPayDate, todayStr());
        const totalPaid = l.payments?.reduce((s,p)=>s+p.amount,0) || 0;
        const status = l.status === 'lunas' ? 'Lunas' : 'Aktif';
        rows += `
          <tr data-id="${l.id}">
            <td><b>${l.name}</b><div class="muted small">${l.contact||''}</div></td>
            <td class="mono">Rp${fmt(l.outstanding)}</td>
            <td class="mono">Rp${fmt(accInt)}</td>
            <td class="mono">Rp${fmt(totalPaid)}</td>
            <td>${status}</td>
            <td>${getDueDate(l)}</td>
            <td>
              <button class="btn" onclick="editLoan('${l.id}');event.stopPropagation()">Edit</button>
              <button class="btn danger" onclick="deleteLoan('${l.id}');event.stopPropagation()">Hapus</button>
            </td>
          </tr>`;
      }
      $('#loan-rows').innerHTML = rows || '<tr><td colspan="7">Tidak ada data</td></tr>';
    }

    $('#btn-generate-report').addEventListener('click', () => {
      const customer = $('#rep-customer').value;
      const start = $('#rep-start').value;
      const end = $('#rep-end').value;
      let reportText = '';

      if (customer) {
        const loan = allLoans.find(l => l.name === customer);
        if (!loan) {
          reportText = 'Customer tidak ditemukan.';
        } else {
          reportText += `LAPORAN PIUTANG\nPeriode: ${start} s/d ${end}\n\n`;
          reportText += `Customer: ${loan.name}\n`;
          reportText += `Kontak: ${loan.contact || '-'}\n`;
          reportText += `Pokok Awal: Rp${fmt(loan.principal)}\n`;
          reportText += `Sisa Pokok: Rp${fmt(loan.outstanding)}\n`;
          reportText += `Status: ${loan.status === 'lunas' ? 'Lunas' : 'Aktif'}\n`;
          reportText += `Jatuh Tempo: ${getDueDate(loan)}\n\n`;

          const payments = loan.payments.filter(p => p.date >= start && p.date <= end);
          if (payments.length) {
            reportText += `Pembayaran:\n`;
            let totalPaid = 0, totalInterest = 0, totalPrincipal = 0;
            payments.forEach(p => {
              reportText += `- ${p.date}: Rp${fmt(p.amount)} (Bunga: Rp${fmt(p.interestPaid)}, Pokok: Rp${fmt(p.principalPaid)}) ${p.note ? `(${p.note})` : ''}\n`;
              totalPaid += p.amount;
              totalInterest += p.interestPaid;
              totalPrincipal += p.principalPaid;
            });
            reportText += `\nTotal Bayar: Rp${fmt(totalPaid)}\n`;
            reportText += `Total Bunga: Rp${fmt(totalInterest)}\n`;
            reportText += `Total Pokok: Rp${fmt(totalPrincipal)}\n`;
          } else {
            reportText += `Tidak ada pembayaran dalam periode ini.\n`;
          }
        }
      } else {
        reportText += `LAPORAN PIUTANG\nPeriode: ${start} s/d ${end}\n\n`;
        allLoans.forEach(l => {
          const payments = l.payments.filter(p => p.date >= start && p.date <= end);
          const sum = payments.reduce((s, x) => s + x.amount, 0);
          if (sum > 0 || l.outstanding > 0) {
            reportText += `${l.name}:\n`;
            reportText += `  Pokok Awal: Rp${fmt(l.principal)}\n`;
            reportText += `  Sisa Pokok: Rp${fmt(l.outstanding)}\n`;
            reportText += `  Bayar: Rp${fmt(sum)} (Bunga: Rp${fmt(payments.reduce((s,x)=>s+x.interestPaid,0))})\n\n`;
          }
        });
      }

      $('#report-output').textContent = reportText;
      $('#report-output').classList.remove('hidden');
    });

    $('#btn-share-wa').addEventListener('click', () => {
      const reportText = $('#report-output').textContent;
      if (!reportText.trim()) return alert('Buat laporan dulu!');
      window.open(waLink('', reportText), '_blank');
    });

    $('#btn-download-pdf').addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(18);
      doc.text("Laporan Piutang", 14, 20);
      doc.setFontSize(12);
      const start = $('#rep-start').value;
      const end = $('#rep-end').value;
      doc.text(`Periode: ${start} s/d ${end}`, 14, 28);
      doc.text($('#report-output').textContent, 14, 35, { maxWidth: 180 });
      doc.save("Laporan-Piutang.pdf");
    });

    window.editLoan = async function(id) {
      const loan = allLoans.find(l => l.id === id);
      if (!loan) return;
      $('#c-name').value = loan.name;
      $('#c-contact').value = loan.contact;
      $('#c-address').value = loan.address;
      $('#c-start').value = loan.start;
      $('#c-principal').value = loan.principal;
      $('#c-rate').value = rateAt(loan, todayStr());
      $('#c-period').value = loan.period;
      $('#c-tenor-value').value = loan.tenorValue;
      $('#c-tenor-unit').value = loan.tenorUnit;
      $('#c-method').value = loan.method;
      $('#c-note').value = loan.note;
      $('#btn-create').textContent = 'Perbarui Pinjaman';
      $('#btn-create').onclick = () => createLoan({
        id, name: $('#c-name').value, contact: $('#c-contact').value, address: $('#c-address').value,
        start: $('#c-start').value, principal: $('#c-principal').value, rate: $('#c-rate').value,
        period: $('#c-period').value, tenorValue: $('#c-tenor-value').value, tenorUnit: $('#c-tenor-unit').value,
        method: $('#c-method').value, note: $('#c-note').value
      });
      document.querySelector('[data-tab="create"]').click();
    };

    window.deleteLoan = async function(id) {
      if (confirm('Hapus pinjaman ini?')) {
        await deleteDoc(doc(db, 'loans', id));
        alert('Pinjaman dihapus.');
      }
    };

    $('#btn-create').onclick = () => {
      const name = $('#c-name').value;
      const principal = $('#c-principal').value;
      if (!name || !principal) return alert('Isi nama dan jumlah');
      createLoan({
        name, contact: $('#c-contact').value, address: $('#c-address').value,
        start: $('#c-start').value, principal, rate: $('#c-rate').value,
        period: $('#c-period').value, tenorValue: $('#c-tenor-value').value, tenorUnit: $('#c-tenor-unit').value,
        method: $('#c-method').value, note: $('#c-note').value
      });
    };

    $('#btn-pay').onclick = () => {
      const id = $('#p-loan').value;
      const amount = $('#p-amount').value;
      if (!id || !amount) return alert('Pilih pinjaman & nominal');
      addPayment(id, {
        date: $('#p-date').value,
        amount,
        note: $('#p-note').value,
        type: $('#p-type').value
      });
    };

    $('#btn-rate').onclick = async () => {
      const id = $('#r-loan').value;
      if (!id || !$('#r-rate').value) return alert('Lengkapi data');
      await addDoc(collection(db, 'loans', id, 'rates'), {
        date: $('#r-date').value,
        rate: Number($('#r-rate').value),
        note: $('#r-note').value
      });
      alert('Bunga diubah');
    };

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(() => {});
    }
  </script>
</body>
</html>
