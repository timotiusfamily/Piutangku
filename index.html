<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PiutangKu - Aplikasi Piutang</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#2563eb" />

  <!-- jsPDF -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --bg: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e6eef9;
      --primary: #2563eb;
      --success: #16a34a;
      --warn: #f59e0b;
      --danger: #dc2626;
      --radius: 14px;
      --shadow: 0 6px 24px rgba(2,6,23,.06);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font: 500 15px/1.6 system-ui, Roboto, 'Segoe UI', Arial; }

    .app { max-width: 980px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; }
    .hidden { display: none !important; }

    /* Login Screen */
    .login-screen {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      min-height: 100vh; padding: 20px; background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
    }
    .login-card {
      width: 100%; max-width: 400px; background: #fff; border-radius: var(--radius); padding: 30px; box-shadow: var(--shadow); text-align: center;
    }
    .login-logo {
      width: 100px; height: 100px; margin: 0 auto 20px; background-image: url('./logo.png'); background-size: cover; background-position: center;
      border-radius: 20px; border: 3px solid var(--primary);
    }
    .login-title { font-size: 24px; font-weight: 700; color: var(--primary); margin-bottom: 16px; }

    /* App Layout */
    header {
      position: sticky; top: 0; background: #fff; border-bottom: 1px solid var(--border); z-index: 50; padding: 16px 20px;
      display: flex; align-items: center; gap: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .logo { width: 60px; height: 60px; border-radius: 12px; background-size: cover; background-position: center; border: 2px solid var(--primary); }
    .brand { font-weight: 800; font-size: 1.4rem; color: var(--primary); }
    .tabs { display: flex; gap: 10px; margin-left: auto; overflow-x: auto; }
    .tab {
      padding: 10px 18px; border-radius: 999px; background: #f1f5f9; color: var(--muted); cursor: pointer;
      white-space: nowrap; transition: all 0.2s; border: 2px solid transparent;
    }
    .tab:hover { background: #e0e7ff; }
    .tab.active { color: #fff; background: var(--primary); border-color: var(--primary); }

    main { flex: 1; padding: 16px; display: grid; gap: 16px; }
    .card { background: #fff; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow); overflow: hidden; }
    .card h2 { margin: 0; padding: 14px 16px 12px; font-size: 18px; border-bottom: 1px dashed var(--border); }
    .card .content { padding: 16px; }
    .grid { display: grid; gap: 12px; }
    .g3 { grid-template-columns: 1fr; }
    @media (min-width: 720px) { .g3 { grid-template-columns: repeat(3,1fr); } }

    label { display: block; font-size: 12px; color: var(--muted); margin: 6px 2px 4px; }
    input, select, textarea, button { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid var(--border); background: #fff; color: var(--text); font-size: 14px; }
    textarea { min-height: 80px; resize: vertical; }

    .stack { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 12px; border-radius: 10px;
      border: 1px solid #cbd9f3; background: #f8fbff; color: var(--text); cursor: pointer; font-size: 14px;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn.primary { background: var(--primary); color: #fff; border-color: var(--primary); }
    .btn.success { background: var(--success); color: #fff; border-color: var(--success); }
    .btn.danger { background: var(--danger); color: #fff; border-color: var(--danger); }

    table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
    th, td { text-align: left; padding: 10px; }
    tr { background: #fff; border: 1px solid var(--border); }
    tr td:first-child { border-radius: 8px 0 0 8px; }
    tr td:last-child { border-radius: 0 8px 8px 0; }
    .muted { color: var(--muted); }
    .small { font-size: 13px; }
    .mono { font-family: monospace; }
  </style>
</head>
<body>

  <!-- LOGIN SCREEN -->
  <div class="login-screen" id="login-screen">
    <div class="login-card">
      <div class="login-logo"></div>
      <h2 class="login-title">PiutangKu</h2>
      <p>Masuk untuk mengelola piutang Anda</p>
      <form id="login-form">
        <div class="grid">
          <div>
            <label>Email</label>
            <input type="email" id="login-email" placeholder="Masukkan email" required />
          </div>
          <div>
            <label>Password</label>
            <input type="password" id="login-password" placeholder="Masukkan password" required />
          </div>
        </div>
        <button type="submit" class="btn primary">Masuk</button>
      </form>
      <!-- Tombol registrasi dihilangkan sesuai permintaan -->
    </div>
  </div>

  <!-- MAIN APP -->
  <div class="app hidden" id="main-app">
    <header>
      <div class="logo" style="background-image: url('./logo.png')"></div>
      <div class="brand">PiutangKu</div>
      <div class="tabs" role="tablist">
        <div class="tab active" data-tab="dashboard">Dashboard</div>
        <div class="tab" data-tab="create">Tambah Pinjaman</div>
        <div class="tab" data-tab="pay">Pembayaran</div>
        <div class="tab" data-tab="list">Daftar Pinjaman</div>
        <div class="tab" data-tab="reports">Laporan</div>
      </div>
    </header>

    <main>
      <!-- DASHBOARD -->
      <section class="card" id="tab-dashboard">
        <h2>Dashboard</h2>
        <div class="content">
          <div class="stats" style="display:grid;gap:12px;grid-template-columns:repeat(auto-fit, minmax(150px,1fr));">
            <div class="stat-card"><h3>Total Pinjaman</h3><div class="value" id="stat-total">Rp0</div></div>
            <div class="stat-card"><h3>Sisa Pokok</h3><div class="value" id="stat-outstanding">Rp0</div></div>
            <div class="stat-card"><h3>Lunas</h3><div class="value" id="stat-paid">0</div></div>
            <div class="stat-card"><h3>Terlambat</h3><div class="value" id="stat-late">0</div></div>
          </div>
        </div>
      </section>

      <!-- CREATE -->
      <section class="card hidden" id="tab-create">
        <h2>Pinjaman Baru</h2>
        <div class="content">
          <div class="grid g3">
            <div><label>Nama Peminjam</label><input id="c-name" /></div>
            <div><label>Kontak (WA)</label><input id="c-contact" /></div>
            <div><label>Alamat</label><input id="c-address" /></div>
            <div><label>Tanggal Pinjam</label><input id="c-start" type="date" /></div>
            <div><label>Jumlah (Rp)</label><input id="c-principal" type="number" /></div>
            <div><label>Bunga %</label><input id="c-rate" type="number" step="0.01" /></div>
            <div><label>Periode</label><select id="c-period"><option value="monthly">Bulanan</option><option value="daily">Harian</option></select></div>
            <div><label>Tempo (Kali)</label><input id="c-tenor" type="number" value="6" /></div>
            <div style="grid-column:1/-1"><label>Catatan</label><textarea id="c-note"></textarea></div>
          </div>
          <div style="margin-top:16px" class="stack">
            <button class="btn primary" id="btn-create">Simpan Pinjaman</button>
          </div>
        </div>
      </section>

      <!-- PAYMENT -->
      <section class="card hidden" id="tab-pay">
        <h2>Pembayaran</h2>
        <div class="content">
          <div class="grid g3">
            <div><label>Pilih Pinjaman</label><select id="p-loan"></select></div>
            <div><label>Tanggal Bayar</label><input id="p-date" type="date" /></div>
            <div><label>Nominal (Rp)</label><input id="p-amount" type="number" /></div>
            <div><label>Jenis</label><select id="p-type"><option value="both">Bunga & Pokok</option></select></div>
            <div><label>Catatan</label><input id="p-note" /></div>
          </div>
          <div style="margin-top:16px" class="stack">
            <button class="btn success" id="btn-pay">Catat Pembayaran</button>
          </div>
        </div>
      </section>

      <!-- LIST -->
      <section class="card hidden" id="tab-list">
        <h2>Daftar Pinjaman</h2>
        <div class="content">
          <div style="overflow:auto">
            <table>
              <thead><tr>
                <th>Peminjam</th><th>Sisa Pokok</th><th>Bunga</th><th>Status</th><th>Aksi</th>
              </tr></thead>
              <tbody id="loan-rows"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- REPORTS -->
      <section class="card hidden" id="tab-reports">
        <h2>Laporan</h2>
        <div class="content">
          <div class="report-section">
            <div><label>Dari Tanggal</label><input id="rep-start" type="date" /></div>
            <div><label>Sampai Tanggal</label><input id="rep-end" type="date" /></div>
            <div><button class="btn primary" id="btn-generate-report">Tampilkan</button></div>
          </div>
          <pre id="report-output" class="hidden" style="background:#f8fafc;padding:12px;border-radius:8px;"></pre>
        </div>
      </section>
    </main>

    <div class="footerbar">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="muted small">PiutangKu - Aplikasi Piutang</div>
        <div style="margin-left:auto" class="stack">
          <button class="btn" id="btn-logout">Keluar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase & App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, serverTimestamp, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Konfigurasi Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDciVnOKpAtRnXdEr-kGPm1tEhStVJw28U",
      authDomain: "piutangku-bfa1a.firebaseapp.com",
      projectId: "piutangku-bfa1a",
      storageBucket: "piutangku-bfa1a.firebasestorage.app",
      messagingSenderId: "238252334346",
      appId: "1:238252334346:web:83ff60aaa7eedb1335eef3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== UTIL =====
    const $ = s => document.querySelector(s);
    const fmt = n => Number(n || 0).toLocaleString('id-ID');
    const todayStr = () => new Date().toISOString().slice(0,10);

    // ===== AUTH =====
    $('#login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = $('#login-email').value.trim();
      const password = $('#login-password').value;

      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (error) {
        alert('Login gagal: ' + error.message);
      }
    });

    $('#btn-logout').addEventListener('click', async () => {
      if (confirm('Yakin ingin keluar?')) {
        await signOut(auth);
      }
    });

    // Tab System
    const tabs = document.querySelectorAll('.tab');
    const sections = document.querySelectorAll('section[id^="tab-"]');

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        sections.forEach(s => s.classList.add('hidden'));
        $(`#tab-${tab.dataset.tab}`).classList.remove('hidden');
      });
    });

    // On Auth State Change
    onAuthStateChanged(auth, (user) => {
      if (user) {
        $('#login-screen').classList.add('hidden');
        $('#main-app').classList.remove('hidden');
        $('#c-start').value = $('#p-date').value = todayStr();
        loadApp(user);
      } else {
        $('#main-app').classList.add('hidden');
        $('#login-screen').classList.remove('hidden');
      }
    });

    // Load Data
    async function loadApp(user) {
      const q = query(collection(db, 'loans'), where('ownerId', '==', user.uid));
      const snap = await getDocs(q);
      const loans = snap.docs.map(d => ({ id: d.id, ...d.data() }));

      // Dashboard
      const total = loans.reduce((s, l) => s + l.principal, 0);
      const outstanding = loans.reduce((s, l) => s + l.outstanding, 0);
      const paid = loans.filter(l => l.status === 'lunas').length;
      const late = loans.filter(l => new Date(l.nextDue) < new Date() && l.status !== 'lunas').length;

      $('#stat-total').textContent = 'Rp' + fmt(total);
      $('#stat-outstanding').textContent = 'Rp' + fmt(outstanding);
      $('#stat-paid').textContent = paid;
      $('#stat-late').textContent = late;

      // List
      let rows = '';
      loans.forEach(l => {
        const status = l.status === 'lunas' ? 'Lunas' : 'Aktif';
        rows += `
          <tr>
            <td><b>${l.name}</b></td>
            <td class="mono">Rp${fmt(l.outstanding)}</td>
            <td class="mono">Rp${fmt(l.accruedInterest || 0)}</td>
            <td>${status}</td>
            <td><button class="btn">Detail</button></td>
          </tr>`;
      });
      $('#loan-rows').innerHTML = rows || '<tr><td colspan="5">Tidak ada pinjaman</td></tr>';

      // Refresh dropdown
      const opts = loans.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
      $('#p-loan').innerHTML = '<option value="">Pilih pinjaman</option>' + opts;
    }

    // Create Loan
    $('#btn-create').onclick = async () => {
      const user = auth.currentUser;
      if (!user) return;

      const name = $('#c-name').value;
      if (!name || !$('#c-principal').value) return alert('Isi nama dan jumlah');

      await addDoc(collection(db, 'loans'), {
        name,
        contact: $('#c-contact').value,
        address: $('#c-address').value,
        start: $('#c-start').value,
        principal: Number($('#c-principal').value),
        outstanding: Number($('#c-principal').value),
        rate: Number($('#c-rate').value),
        period: $('#c-period').value,
        tenor: Number($('#c-tenor').value),
        method: 'principal_interest',
        note: $('#c-note').value,
        status: 'active',
        ownerId: user.uid,
        nextDue: $('#c-start').value,
        createdAt: serverTimestamp()
      });

      alert('Pinjaman berhasil ditambahkan');
      $('#c-name').value = '';
      loadApp(user); // Refresh
    };

    // Payment
    $('#btn-pay').onclick = async () => {
      const user = auth.currentUser;
      const loanId = $('#p-loan').value;
      const amount = $('#p-amount').value;

      if (!loanId || !amount) return alert('Lengkapi data');

      const loanRef = doc(db, 'loans', loanId);
      const loanSnap = await getDoc(loanRef);
      const loan = loanSnap.data();

      const interest = loan.outstanding * (loan.rate / 100);
      const principal = Math.min(amount, loan.outstanding);
      const newOut = Math.max(0, loan.outstanding - principal);

      await updateDoc(loanRef, {
        outstanding: newOut,
        status: newOut <= 0 ? 'lunas' : 'active'
      });

      alert(`Dibayar: Pokok Rp${fmt(principal)}, Bunga Rp${fmt(interest)}`);
      loadApp(user);
    };

    // Report
    $('#btn-generate-report').onclick = () => {
      const start = $('#rep-start').value;
      const end = $('#rep-end').value;
      const output = $('#report-output');
      output.textContent = `Laporan dari ${start} sampai ${end}\n\nTidak ada data untuk ditampilkan.`;
      output.classList.remove('hidden');
    };
  </script>
</body>
</html>